<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: appServer.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: appServer.js</h1>

    


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/** @file appServer.js Endpoints for app request
 *  @module Other
 * */
define([
    'path',
    'node-promise',
    'express',
    'body-parser',
    'method-override',
    'errorhandler',
    'log',
    'appConfig',
    'databaseConfig',
    'util/actionHandler',
    'util/modelEndpointHandler',
    'middleware/authentication',
    'middleware/dbconnection'
], /** @lends Other */ function (path, promise, express, bodyParser, methodOverride, errorHandler, log, appConfig, databaseConfig, actionHandler, modelEndpointHandler, authentication, dbconnection) {
    'use strict';

    var app = express(),
        server,
        Promise = promise.Promise,
        q = new Promise();

    // load models and endpoints
    modelEndpointHandler.load().then(function (results) {
        var models = results[0],
            endpoints = results[1];

        // get called action
        function execAction(req, res) {
            var params = req.params,
                className = params.classname,
                version = params.version,
                isObject = params.objectid ? true : false,
                endpoint;

            // load model and endpoint by class
            if (version &amp;&amp; className &amp;&amp; models[className] &amp;&amp; endpoints[className]) {
                endpoint = endpoints[className];

                return actionHandler(req, res, endpoint, isObject);
            }
            res.send(404, 'no_classname');
        }

        // Config
        app.use(bodyParser.json());
        app.use(bodyParser.urlencoded({
            extended: true
        }));
        app.use(methodOverride()); // HTTP PUT and DELETE support
        app.use(express.static(path.join(process.cwd(), 'static', 'public'))); // static file server
        app.use(errorHandler({ dumpExceptions: true, showStack: true })); // error stacks
        app.param('db', dbconnection); // use dbconnection cache
        app.param('db', authentication); // use authentication middleware

        // Launch server
        server = app.listen(appConfig.port, function () {
            log.info('Listening on port %d', server.address().port);
        });

        /**
         * @function api
         * @description Checks if api is online
         * @property /api - url
         * @property {GET} Method - request method
         * @property Authorization - set request header Authorization: TOKENTYPE ACCESSTOKEN
         * @return {string} api_online - returned as request.text
         */
        app.get('/api', function (req, res) {
            res.send('api_online');
        });
        /**
         * @function api/config
         * @description returns system config
         * @property /api/config - url
         * @property {GET} Method - request method
         * @return {object} systemconfig - system config with default values for e.g. interests, roles, message types
         */
        app.get('/api/config', function (req, res) {
            // deep clone appConfig object
            var resAppConfig = JSON.parse(JSON.stringify(appConfig));

            delete resAppConfig.secret;
            resAppConfig.version = 'v1';
            resAppConfig.systemdb = databaseConfig.systemdb;

            res.send(resAppConfig);
        });

        // set generic provided api class urls
        app.all('/api/:version/:db/:classname/:action?', execAction);
        // set generic provided api object urls
        app.all('/api/:version/:db/:classname/id/:objectid/:action?', execAction);

        q.resolve(server);

    }, log.error);

    return q;
});</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Modules</h3><ul><li><a href="module-Authentication.html">Authentication</a></li><li><a href="module-Client.html">Client</a></li><li><a href="module-Other.html">Other</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha8</a> on Sat Aug 23 2014 15:45:32 GMT+0200 (CEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
